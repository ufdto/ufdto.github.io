---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Collections
const landschaften = await getCollection("landschaft");
const orte = await getCollection("stellen");
const ortschaften = await getCollection("ortschaften");

// Spezielle Seiten
import { chronik as luftbild1946 } from "./luftbild-1946.astro";
import { chronik as ortschaftenUmPechgruen } from "./ortschaften/um-pechgruen.astro";

// Personen
import { chronik as personenEinwohnermeldebuch } from "./personen-einwohnermeldebuch.astro";
import { chronik as personenStammbaum } from "./personen-stammbaum.astro";

// Texte (Heinzl)
import { chronik as aHooch } from "./a-hooch-aaf-unna-dorf.astro";
import { chronik as meineErinnerungen } from "./meine-erinnerungen-heimatdorf-pechgruen.astro";
import { chronik as texteUebersicht } from "./texte.astro";

// Redelbach
import { chronik as redelbachIndex } from "./redelbach/index.astro";
import { chronik as redelbachSketchbook } from "./redelbach/sketchbook.astro";
import { chronik as redelbachErinnerungen } from "./redelbach/erinnerungen.astro";
import { chronik as redelbachGedicht } from "./redelbach/gedicht.astro";
import { chronik as redelbachGallery } from "./redelbach/gallery.astro";

const redelbachEntries = [
  redelbachIndex,
  redelbachSketchbook,
  redelbachErinnerungen,
  redelbachGedicht,
  redelbachGallery,
];

// ---------- Landschaft: Sortierung ältester Eintrag oben ----------
// Primär: date (aufsteigend)
// Sekundär (bei gleichem Tag): order (aufsteigend, kleinere Zahl = älter)
const landschaftenSorted = [...landschaften].sort((a, b) => {
  const da = new Date(a.data.date).getTime();
  const db = new Date(b.data.date).getTime();
  if (da !== db) return da - db;

  const oa = Number(a.data.order ?? 0);
  const ob = Number(b.data.order ?? 0);
  return oa - ob;
});
---

<BaseLayout title="Einstieg">
  <h1>Einstieg</h1>
  <p class="subtitle">Spuren, die zu Pechgrün führen</p>

  <section class="intro">
    <p>
      Pechgrün ist verschwunden. Die Häuser sind fort, die Wege von einer
      Abraumhalde überdeckt, die Landschaft über dem Ort neu geformt. Was
      geblieben ist, sind Spuren – und Erinnerungen. Und selbst diese sind
      inzwischen selten geworden.
    </p>

    <p>
      Diese Seite ist der Einstieg in die Website. Die Bereiche darunter zeigen
      verschiedene Spuren, die zu Pechgrün führen: über Landschaft, Stellen & Gebäude,
      Dokumente, Texte, Bilder und Menschen.
    </p>

    <p>
      Wenn du zum ersten Mal hier bist, beginnt der Weg sinnvollerweise bei der
      Landschaft. Sie ist das, was heute noch sichtbar ist – auch wenn der Ort
      selbst verschwunden ist. Von dort führen die Spuren weiter.
    </p>

    <p>
      Es gibt keinen festen Weg. Du kannst überall einsteigen und jederzeit
      zurückkehren. Diese Seite ist ein Wegweiser, kein Ablaufplan.
    </p>
  </section>

  <div class="accordion" data-accordion>
    <!-- Landschaft -->
    <section class="acc">
      <button class="acc-head" type="button" aria-expanded="true">
        <span class="acc-title">Landschaft</span>
        <span class="acc-right">
          <span class="acc-meta">
            {landschaftenSorted.length.toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          {landschaftenSorted.map((e) => (
            <li>
              <a href={`/landschaft/${e.slug}`}>{e.data.title}</a>
              {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
            </li>
          ))}
        </ul>
      </div>
    </section>

    <!-- Stellen & Gebäude -->
    <section class="acc">
      <button class="acc-head" type="button" aria-expanded="true">
        <span class="acc-title">Stellen & Gebäude</span>
        <span class="acc-right">
          <span class="acc-meta">
            {(orte.length + 1).toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li>
            <a href={luftbild1946.href}>{luftbild1946.title}</a>
            {luftbild1946.subtitle ? <span> — {luftbild1946.subtitle}</span> : null}
          </li>

          {orte
            .sort((a, b) => a.data.title.localeCompare(b.data.title, "de"))
            .map((e) => (
              <li>
                <a href={`/stellen/`}>{e.data.title}</a>
                {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
              </li>
            ))}
        </ul>
      </div>
    </section>

    <!-- Ortschaften -->
    <section class="acc">
      <button class="acc-head" type="button" aria-expanded="true">
        <span class="acc-title">Ortschaften</span>
        <span class="acc-right">
          <span class="acc-meta">
            {(ortschaften.length + 1).toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li>
            <a href={ortschaftenUmPechgruen.href}>{ortschaftenUmPechgruen.title}</a>
            {ortschaftenUmPechgruen.subtitle ? (
              <span> — {ortschaftenUmPechgruen.subtitle}</span>
            ) : null}
          </li>

          {ortschaften
            .sort((a, b) => a.data.title.localeCompare(b.data.title, "de"))
            .map((e) => (
              <li>
                <a href={`/ortschaften/${e.slug}`}>{e.data.title}</a>
                {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
              </li>
            ))}
        </ul>
      </div>
    </section>

    <!-- Personen -->
    <section class="acc">
      <button class="acc-head" type="button" aria-expanded="true">
        <span class="acc-title">Personen</span>
        <span class="acc-right">
          <span class="acc-meta">2 Werkzeuge</span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li><a href={personenEinwohnermeldebuch.href}>{personenEinwohnermeldebuch.title}</a></li>
          <li><a href={personenStammbaum.href}>{personenStammbaum.title}</a></li>
        </ul>
      </div>
    </section>

    <!-- Texte -->
    <section class="acc">
      <button class="acc-head" type="button" aria-expanded="true">
        <span class="acc-title">Texte, Stimmen und Erinnerungen</span>
        <span class="acc-right">
          <span class="acc-meta">3 Einträge</span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li><a href={texteUebersicht.href}>{texteUebersicht.title}</a></li>
          <li><a href={meineErinnerungen.href}>{meineErinnerungen.title}</a></li>
          <li><a href={aHooch.href}>{aHooch.title}</a></li>
        </ul>
      </div>
    </section>

    <!-- Karl Redelbach -->
    <section class="acc">
      <button class="acc-head" type="button" aria-expanded="true">
        <span class="acc-title">Karl Redelbach</span>
        <span class="acc-right">
          <span class="acc-meta">{redelbachEntries.length} Einträge</span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          {redelbachEntries.map((e) => (
            <li>
              <a href={e.href}>{e.title}</a>
              {e.subtitle ? <span> — {e.subtitle}</span> : null}
            </li>
          ))}
        </ul>
      </div>
    </section>
  </div>
</BaseLayout>

<script is:inline>
  (() => {
    const root = document.querySelector("[data-accordion]");
    if (!root) return;

    const sections = root.querySelectorAll(".acc");
    sections.forEach((sec) => {
      const btn = sec.querySelector(".acc-head");
      const body = sec.querySelector(".acc-body");
      const arrow = sec.querySelector(".acc-arrow");
      if (!btn || !body || !arrow) return;

      const sync = (expanded) => {
        btn.setAttribute("aria-expanded", String(expanded));
        body.hidden = !expanded;
        arrow.textContent = expanded ? "▲" : "▼";
      };

      const expanded = btn.getAttribute("aria-expanded") !== "false";
      sync(expanded);

      btn.addEventListener("click", () => {
        const isOpen = btn.getAttribute("aria-expanded") === "true";
        sync(!isOpen);
      });
    });
  })();
</script>

<style>
  .subtitle {
    margin: 0.25rem 0 1.25rem;
    font-size: 1.15rem;
    opacity: 0.8;
  }

  .intro {
    max-width: 860px;
    margin-bottom: 2rem;
  }

  .accordion {
    margin-top: 22px;
    display: grid;
    gap: 26px;
  }

  .acc-head {
    all: unset;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box;
    cursor: pointer;
  }

  .acc-title {
    font-size: 1.85rem;
    font-weight: 750;
    line-height: 1.1;
    letter-spacing: -0.01em;
    min-width: 0;
  }

  .acc-right {
    display: inline-flex;
    align-items: baseline;
    gap: 10px;
    flex: 0 0 auto;
    margin-left: 14px;
  }

  .acc-meta {
    color: rgba(0, 0, 0, 0.55);
    font-size: 0.95rem;
    white-space: nowrap;
  }

  .acc-arrow {
    color: rgba(0, 0, 0, 0.6);
    font-size: 1.05rem;
    line-height: 1;
    width: 1.1em;
    text-align: center;
  }

  .acc-body {
    margin-top: 10px;
  }

  ul {
    margin: 8px 0 0;
    padding-left: 18px;
  }

  li {
    margin: 6px 0;
  }
</style>
