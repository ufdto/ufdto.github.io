---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Collections
const landschaften = await getCollection("landschaft");
const geschichte = await getCollection("geschichte");
const orte = await getCollection("stellen");
const wege = await getCollection("wege");
const ortschaften = await getCollection("ortschaften");
const personen = await getCollection("personen");

const wegeOrder = [
  "pechgruener-strasse",
  "oberesdorf-wehrmuehle",
  "oberesdorf-spitzeich",
  "gasthaeuser",
  "vogelsang",
  "mittleresdorf",
  "unteresdorf",
  "neurohlau-weg1",
  "neurohlau-weg2",
  "neurohlau-weg3",
  "haus-24",
];

// Spezielle Seiten
import { chronik as stellenIndex } from "./stellen/index.astro";
import { chronik as wegeIndex } from "./wege/index.astro";
import { chronik as ortschaftenUmPechgruen } from "./ortschaften/um-pechgruen.astro";

// Personen (Werkzeuge)
import { chronik as personenEinwohnermeldebuch } from "./personen-einwohnermeldebuch.astro";
import { chronik as personenStammbaum } from "./personen-stammbaum.astro";
import { chronik as gallery } from "./personen/gallery.astro";

// Texte (Heinzl)
import { chronik as aHooch } from "./a-hooch-aaf-unna-dorf.astro";
import { chronik as meineErinnerungen } from "./meine-erinnerungen-heimatdorf-pechgruen.astro";
import { chronik as texteUebersicht } from "./texte.astro";
import { chronik as egerlaenderMundart } from "./egerlaendermundart.astro";
import { chronik as redelbachTeich } from "./redelbach-teich.astro";
import { chronik as woerterbuch } from "./woerterbuch.astro";

// Redelbach
import { chronik as redelbachIndex } from "./redelbach/index.astro";
import { chronik as redelbachSketchbook } from "./redelbach/sketchbook.astro";
import { chronik as redelbachErinnerungen } from "./redelbach/erinnerungen.astro";
import { chronik as redelbachGedicht } from "./redelbach/gedicht.astro";
import { chronik as redelbachGallery } from "./redelbach/gallery.astro";

const redelbachEntries = [
  redelbachIndex,
  redelbachSketchbook,
  redelbachErinnerungen,
  redelbachGedicht,
  redelbachGallery,
];

/* ------------------------------------------------------------------
   Date handling: base.date ist jetzt STRING.
   Für Sortierung (Landschaft/Geschichte) versuchen wir ISO ("YYYY-MM-DD")
   zu parsen. Falls unparsbar -> Datum = 0 (ganz früh), damit es nicht crasht.
   ------------------------------------------------------------------ */
const toTime = (s: unknown) => {
  const d = new Date(String(s));
  const t = d.getTime();
  return Number.isNaN(t) ? 0 : t;
};

// ---------- Landschaft: Sortierung ältester Eintrag oben ----------
const landschaftenSorted = [...landschaften].sort((a, b) => {
  const da = toTime(a.data.date);
  const db = toTime(b.data.date);
  if (da !== db) return da - db;

  const oa = Number(a.data.order ?? 0);
  const ob = Number(b.data.order ?? 0);
  return oa - ob;
});

// ---------- Geschichte: Sortierung ältester Eintrag oben ----------
const geschichteSorted = [...geschichte].sort((a, b) => {
  const da = toTime(a.data.date);
  const db = toTime(b.data.date);
  if (da !== db) return da - db;

  const oa = Number(a.data.order ?? 0);
  const ob = Number(b.data.order ?? 0);
  return oa - ob;
});

/* ------------------------------------------------------------------
   ✅ Landschaft soll auch Astro-Seiten enthalten (z.B. Flurnamen)
   ------------------------------------------------------------------ */
const landschaftPageModules = import.meta.glob("./landschaft/*.astro", {
  eager: true,
}) as Record<string, any>;

const landschaftPages = Object.entries(landschaftPageModules)
  .map(([, mod]) => mod?.chronik)
  .filter(Boolean)
  .filter((c: any) => String(c.bereich ?? "") === "Landschaft")
  .map((c: any) => {
    const d = new Date(String(c.date));
    const t = d.getTime();
    return {
      kind: "page" as const,
      title: String(c.title ?? ""),
      subtitle: String(c.subtitle ?? ""),
      date: Number.isNaN(t) ? new Date(0) : d, // fallback
      order: typeof c.order === "number" ? c.order : 0,
      href: String(c.href ?? "#"),
    };
  })
  .filter((x) => x.title && x.href);

const landschaftContentItems = landschaftenSorted.map((e) => {
  const d = new Date(String(e.data.date));
  const t = d.getTime();
  return {
    kind: "content" as const,
    title: e.data.title as string,
    subtitle: (e.data.subtitle as string | undefined) ?? "",
    date: Number.isNaN(t) ? new Date(0) : d,
    order: Number(e.data.order ?? 0),
    href: `/landschaft/${e.slug}`,
  };
});

// Sortierung wie bisher: ältester oben
const landschaftCombined = [...landschaftContentItems, ...landschaftPages].sort(
  (a, b) => {
    const da = a.date.getTime();
    const db = b.date.getTime();
    if (da !== db) return da - db;
    return (a.order ?? 0) - (b.order ?? 0);
  }
);
---

<BaseLayout title="Inhalt">
  <h1>Inhalt</h1>
  <p class="subtitle">Übersicht und Zugang zu allen Bereichen</p>

  <section class="intro">
    <p>
      Pechgrün ist verschwunden. Die Häuser sind fort, die Wege von einer
      Abraumhalde überdeckt, die Landschaft über dem Ort neu geformt. Was
      geblieben ist, sind Spuren – in Karten, Bildern, Texten und Erinnerungen.
    </p>

    <p>
      Diese Seite bietet eine vollständige Übersicht über die Inhalte dieser
      Website. Sie führt zu Landschaften, Stellen und Gebäuden, historischen
      Darstellungen, Texten, Stimmen, Bildern und Personen.
    </p>

    <p>
      Anders als der <em>Rundgang</em> folgt diese Seite keiner empfohlenen Reihenfolge.
      Sie ist als offener Zugang gedacht – zum gezielten Nachschlagen, zum Wiederfinden
      bestimmter Themen oder zum freien Stöbern.
    </p>

    <p>
      Du kannst hier überall einsteigen, Abschnitte auf- und zuklappen und
      jederzeit zurückkehren. Diese Seite ist ein Inhaltsverzeichnis – kein
      vorgeschriebener Weg.
    </p>
  </section>

  <div class="accordion" data-accordion>
    <!-- Landschaft -->
    <section class="acc" data-acc-id="landschaft">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Landschaft</span>
        <span class="acc-right">
          <span class="acc-meta">
            {landschaftCombined.length.toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          {
            landschaftCombined.map((e) => (
              <li>
                <a href={e.href}>{e.title}</a>
                {e.subtitle ? <span> — {e.subtitle}</span> : null}
              </li>
            ))
          }
        </ul>
      </div>
    </section>

    <!-- Geschichte -->
    <section class="acc" data-acc-id="geschichte">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Geschichte</span>
        <span class="acc-right">
          <span class="acc-meta">
            {geschichteSorted.length.toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          {
            geschichteSorted.map((e) => (
              <li>
                <a href={`/geschichte/${e.slug}`}>{e.data.title}</a>
                {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
              </li>
            ))
          }
        </ul>
      </div>
    </section>

    <!-- Stellen & Gebäude -->
    <section class="acc" data-acc-id="stellen">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Stellen &amp; Gebäude</span>
        <span class="acc-right">
          <span class="acc-meta">
            {(orte.length + 2).toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li>
            <a href={stellenIndex.href}>{stellenIndex.title}</a>
            {
              stellenIndex.subtitle ? (
                <span> — {stellenIndex.subtitle}</span>
              ) : null
            }
          </li>

          <li>
            <a href="/stellen/gallery">Häuser Galerie</a>
            <span>
              — Fotografien und Karten der ehemaligen Ortschaft Pechgrün</span
            >
          </li>

          {
            orte
              .sort((a, b) => a.data.title.localeCompare(b.data.title, "de"))
              .map((e) => (
                <li>
                  <a href={`/stellen/${e.slug}`}>{e.data.title}</a>
                  {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
                </li>
              ))
          }
        </ul>
      </div>
    </section>

    <!-- Wege -->
    <section class="acc" data-acc-id="wege">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Wege</span>
        <span class="acc-right">
          <span class="acc-meta">
            {(wege.length + 1).toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li>
            <a href={wegeIndex.href}>{wegeIndex.title}</a>
            {wegeIndex.subtitle ? <span> — {wegeIndex.subtitle}</span> : null}
          </li>

          {
            wegeOrder.map((slug) => {
              const e = wege.find((x) => x.slug === slug);
              if (!e) return null;

              return (
                <li>
                  <a href={`/wege/${e.slug}`}>{e.data.title}</a>
                  {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
                </li>
              );
            })
          }
        </ul>
      </div>
    </section>

    <!-- Ortschaften -->
    <section class="acc" data-acc-id="ortschaften">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Ortschaften</span>
        <span class="acc-right">
          <span class="acc-meta">
            {(ortschaften.length + 1).toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li>
            <a href={ortschaftenUmPechgruen.href}
              >{ortschaftenUmPechgruen.title}</a
            >
            {
              ortschaftenUmPechgruen.subtitle ? (
                <span> — {ortschaftenUmPechgruen.subtitle}</span>
              ) : null
            }
          </li>

          {
            ortschaften
              .sort((a, b) => a.data.title.localeCompare(b.data.title, "de"))
              .map((e) => (
                <li>
                  <a href={`/ortschaften/${e.slug}`}>{e.data.title}</a>
                  {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
                </li>
              ))
          }
        </ul>
      </div>
    </section>

    <!-- Personen -->
    <section class="acc" data-acc-id="personen">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Personen</span>
        <span class="acc-right">
          <span class="acc-meta">
            {(personen.length + 3).toLocaleString("de-DE")} Einträge
          </span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <!-- Werkzeuge -->
          <li>
            <a href={personenEinwohnermeldebuch.href}
              >{personenEinwohnermeldebuch.title}</a
            >
          </li>
          <li>
            <a href={personenStammbaum.href}>{personenStammbaum.title}</a>
          </li>
          <!-- Galerie -->
          <li>
            <a href={gallery.href}>{gallery.title}</a>
            {gallery.subtitle ? <span> — {gallery.subtitle}</span> : null}
          </li>

          <!-- Personen-Detailseiten -->
          {
            personen
              .sort((a, b) => a.data.title.localeCompare(b.data.title, "de"))
              .map((e) => (
                <li>
                  <a href={`/personen/${e.slug}`}>{e.data.title}</a>
                  {e.data.subtitle ? <span> — {e.data.subtitle}</span> : null}
                </li>
              ))
          }
        </ul>
      </div>
    </section>

    <!-- Texte -->
    <section class="acc" data-acc-id="texte">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Texte, Stimmen und Erinnerungen</span>
        <span class="acc-right">
          <span class="acc-meta">6 Einträge</span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          <li><a href={texteUebersicht.href}>{texteUebersicht.title}</a></li>
          <li>
            <a href={egerlaenderMundart.href}>{egerlaenderMundart.title}</a>
          </li>
          <li>
            <a href={woerterbuch.href}>{woerterbuch.title}</a>
          </li>
          <li>
            <a href={meineErinnerungen.href}>{meineErinnerungen.title}</a>
          </li>
          <li><a href={aHooch.href}>{aHooch.title}</a></li>
          <li><a href={redelbachTeich.href}>{redelbachTeich.title}</a></li>
        </ul>
      </div>
    </section>

    <!-- Karl Redelbach -->
    <section class="acc" data-acc-id="redelbach">
      <button class="acc-head" type="button" aria-expanded="false">
        <span class="acc-title">Karl Redelbach</span>
        <span class="acc-right">
          <span class="acc-meta">{redelbachEntries.length} Einträge</span>
          <span class="acc-arrow" aria-hidden="true">▲</span>
        </span>
      </button>

      <div class="acc-body">
        <ul>
          {
            redelbachEntries.map((e) => (
              <li>
                <a href={e.href}>{e.title}</a>
                {e.subtitle ? <span> — {e.subtitle}</span> : null}
              </li>
            ))
          }
        </ul>
      </div>
    </section>
  </div>
</BaseLayout>

<script is:inline>
  (() => {
    const root = document.querySelector("[data-accordion]");
    if (!root) return;

    const STORAGE_KEY = "pechgruen_inhalt_accordion_v1";

    let state = {};
    try {
      state = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    } catch {
      state = {};
    }

    const sections = root.querySelectorAll(".acc");
    sections.forEach((sec) => {
      const id = sec.getAttribute("data-acc-id") || "";
      const btn = sec.querySelector(".acc-head");
      const body = sec.querySelector(".acc-body");
      const arrow = sec.querySelector(".acc-arrow");
      if (!btn || !body || !arrow) return;

      const sync = (expanded) => {
        btn.setAttribute("aria-expanded", String(expanded));
        body.hidden = !expanded;
        arrow.textContent = expanded ? "▲" : "▼";
      };

      // Default: geschlossen (false). Gespeicherter Zustand überschreibt Default.
      let expanded = false;
      if (id && Object.prototype.hasOwnProperty.call(state, id)) {
        expanded = Boolean(state[id]);
      }

      sync(expanded);

      btn.addEventListener("click", () => {
        expanded = !expanded;
        sync(expanded);

        if (id) {
          state[id] = expanded;
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch {
            // ignore
          }
        }
      });
    });
  })();
</script>

<style>
  h1 {
    margin-bottom: 0.25rem;
  }

  .subtitle {
    margin-top: 0;
    margin: 0.25rem 0 1.25rem;
    font-size: 1.15rem;
    opacity: 0.8;
  }

  .intro {
    max-width: 860px;
    margin-bottom: 2rem;
  }

  .accordion {
    margin-top: 22px;
    display: grid;
    gap: 26px;
  }

  .acc-head {
    all: unset;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box;
    cursor: pointer;
  }

  .acc-title {
    font-size: 1.85rem;
    font-weight: 750;
    line-height: 1.1;
    letter-spacing: -0.01em;
    min-width: 0;
  }

  .acc-right {
    display: inline-flex;
    align-items: baseline;
    gap: 10px;
    flex: 0 0 auto;
    margin-left: 14px;
  }

  .acc-meta {
    color: rgba(0, 0, 0, 0.55);
    font-size: 0.95rem;
    white-space: nowrap;
  }

  .acc-arrow {
    color: rgba(0, 0, 0, 0.6);
    font-size: 1.05rem;
    line-height: 1;
    width: 1.1em;
    text-align: center;
  }

  .acc-body {
    margin-top: 10px;
  }

  ul {
    margin: 8px 0 0;
    padding-left: 18px;
  }

  li {
    margin: 6px 0;
  }
</style>
