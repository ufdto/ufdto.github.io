---
import BaseLayout from "../../layouts/BaseLayout.astro";
import rawDescriptorsById from "../../assets/haeuser/descriptors.byId.json";

export const chronik = {
  title: "Pechgrün – Häuser",
  subtitle: "Fotogalerie (92 Aufnahmen)",
  date: "2025-12-25",
  bereich: "Orte",
  href: "/orte/gallery",
  order: 3,
};

const VIEW_MAX = 800;     // Zielbreite
const PORTRAIT_H = 520;   // fixe Höhe nur Portrait

// ✅ JSON sauber typisieren (sonst TS7053 beim Indexen)
const descriptorsById = rawDescriptorsById as Record<string, string>;

// ✅ Glob-Module typisieren (sonst implicit any)
type UrlMods = Record<string, string>;

const fullMods = import.meta.glob("/src/assets/haeuser/*-full.jpg", {
  eager: true,
  query: "?url",
  import: "default",
}) as UrlMods;

const smallMods = import.meta.glob("/src/assets/haeuser/small/*-small.jpg", {
  eager: true,
  query: "?url",
  import: "default",
}) as UrlMods;

function buildUrlMap(mods: UrlMods): Map<string, string> {
  const map = new Map<string, string>();
  for (const [path, url] of Object.entries(mods)) {
    const file = path.split("/").pop() ?? "";
    const id = file.replace("-small.jpg", "").replace("-full.jpg", "");
    map.set(id, url);
  }
  return map;
}

const fullMap = buildUrlMap(fullMods);
const smallMap = buildUrlMap(smallMods);

const COUNT = 92;
const order: string[] = Array.from({ length: COUNT }, (_, i) =>
  `h${String(i + 1).padStart(3, "0")}`
);

type Item = {
  id: string;
  small: string;
  full: string;
  title: string;
  desc: string;
};

const items: Item[] = order
  .filter((id) => smallMap.has(id) && fullMap.has(id))
  .map((id) => ({
    id,
    small: smallMap.get(id)!,
    full: fullMap.get(id)!,
    title: id.toUpperCase(),
    desc: typeof descriptorsById[id] === "string" ? descriptorsById[id] : "",
  }));

const splitLines = (s: string) => String(s || "").split(/\r?\n/);
---

<BaseLayout title={chronik.title}>
  <article class="page">
    <header class="head">
      <h1>{chronik.title}</h1>
      <p class="subtitle">{chronik.subtitle}</p>
    </header>

    <section class="intro">
      <p>
        Fotografien der Häuser von Pechgrün. Die Bildauswahl erfolgt über den
        Thumbnail-Streifen oberhalb des Bildes.
      </p>
      <p class="hint">
        Tipp: Mit den Pfeiltasten ← / → wechseln oder über die Thumbnails oben direkt springen.
      </p>
    </section>

    {items.length === 0 ? (
      <p>Keine Bilder gefunden. Prüfe bitte <code>src/assets/haeuser/</code>.</p>
    ) : (
      <section class="viewer viewer-wrap" data-gallery>
        <!-- DEBUG (zum Testen, ob diese Datei wirklich gerendert wird) -->
        <!-- <p style="color:red;font-weight:700">DEBUG: gallery.astro loaded</p> -->

        <div class="frame">
          <div class="strip-scroll" aria-label="Bildauswahl">
            <div class="strip" data-strip>
              {items.map((it, idx) => (
                <button
                  class={"thumb" + (idx === 0 ? " is-active" : "")}
                  type="button"
                  data-thumb
                  data-index={idx}
                  aria-label={`Bild wählen: ${it.id.toUpperCase()}`}
                  title={it.id.toUpperCase()}
                >
                  <img src={it.small} alt="" loading="lazy" />
                </button>
              ))}
            </div>
          </div>

          <figure class="hero">
            <button class="hero-btn" type="button" data-open aria-label="Originalansicht öffnen">
              <div class="hero-frame is-landscape" data-hero-frame>
                <img src={items[0].small} alt={items[0].title} loading="eager" data-hero-img />
              </div>
            </button>

            <figcaption class="caption" data-caption>
              {items[0].desc ? (
                <span class="cap-desc">
                  {splitLines(items[0].desc).map((line, i) => (
                    <>
                      {i > 0 ? <br /> : null}
                      {line}
                    </>
                  ))}
                </span>
              ) : null}
            </figcaption>
          </figure>
        </div>

        <dialog class="dlg" data-dialog>
          <div class="dlg-inner">
            <div class="dlg-head">
              <div class="dlg-title" data-dlg-title>{items[0].title}</div>
              <button type="button" class="dlg-close" data-close aria-label="Schließen">×</button>
            </div>

            <div class="dlg-body">
              <img class="dlg-img" data-dlg-img src={items[0].full} alt={items[0].title} loading="lazy" />
              <div class="dlg-meta" data-dlg-meta style={items[0].desc ? "" : "display:none"}>
                {items[0].desc
                  ? splitLines(items[0].desc).map((line, i) => (
                      <>
                        {i > 0 ? <br /> : null}
                        {line}
                      </>
                    ))
                  : null}
              </div>
            </div>

            <div class="dlg-foot">
              <a class="dlg-open" data-dlg-open href={items[0].full} target="_blank" rel="noopener">
                In neuem Tab öffnen
              </a>
            </div>
          </div>
        </dialog>

        <script is:inline define:vars={{ items, PORTRAIT_H }}>
          (() => {
            const root = document.querySelector("[data-gallery]");
            if (!root) return;

            const heroFrame = root.querySelector("[data-hero-frame]");
            const heroImg = root.querySelector("[data-hero-img]");
            const caption = root.querySelector("[data-caption]");
            const thumbs = Array.from(root.querySelectorAll("[data-thumb]"));

            const dlg = root.querySelector("[data-dialog]");
            const openBtn = root.querySelector("[data-open]");
            const closeBtn = root.querySelector("[data-close]");
            const dlgImg = root.querySelector("[data-dlg-img]");
            const dlgTitle = root.querySelector("[data-dlg-title]");
            const dlgMeta = root.querySelector("[data-dlg-meta]");
            const dlgOpen = root.querySelector("[data-dlg-open]");

            let index = 0;
            const clamp = (i) => (i + items.length) % items.length;

            const setActiveThumb = (i) => {
              thumbs.forEach((t, k) => t.classList.toggle("is-active", k === i));
              thumbs[i]?.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
            };

            const renderCaption = (text) => {
              caption.innerHTML = "";
              if (!text) return;
              String(text).split(/\r?\n/).forEach((line, i) => {
                if (i > 0) caption.appendChild(document.createElement("br"));
                caption.appendChild(document.createTextNode(line));
              });
            };

            const renderDlgMeta = (text) => {
              if (!dlgMeta) return;
              dlgMeta.innerHTML = "";
              if (!text) {
                dlgMeta.style.display = "none";
                return;
              }
              dlgMeta.style.display = "";
              String(text).split(/\r?\n/).forEach((line, i) => {
                if (i > 0) dlgMeta.appendChild(document.createElement("br"));
                dlgMeta.appendChild(document.createTextNode(line));
              });
            };

            const applyOrientationFor = (src) => {
              const probe = new Image();
              probe.onload = () => {
                const portrait = probe.naturalHeight > probe.naturalWidth;
                heroFrame.classList.toggle("is-portrait", portrait);
                heroFrame.classList.toggle("is-landscape", !portrait);
              };
              probe.src = src;
            };

            const render = (i) => {
              const it = items[i];
              if (!it) return;
              index = i;

              applyOrientationFor(it.small);

              heroImg.src = it.small;
              heroImg.alt = it.title;

              renderCaption(it.desc);

              dlgImg.src = it.full;
              dlgImg.alt = it.title;
              dlgTitle.textContent = it.title;
              renderDlgMeta(it.desc);

              dlgOpen.href = it.full;
              setActiveThumb(i);
            };

            thumbs.forEach((btn) => btn.addEventListener("click", () => render(Number(btn.dataset.index))));

            openBtn.addEventListener("click", () => dlg.showModal());
            closeBtn.addEventListener("click", () => dlg.close());
            dlg.addEventListener("click", (e) => e.target === dlg && dlg.close());

            const onKeyDown = (e) => {
              if (e.metaKey || e.ctrlKey || e.altKey) return;
              if (e.key === "ArrowLeft") render(clamp(index - 1));
              else if (e.key === "ArrowRight") render(clamp(index + 1));
              else if (e.key === "Escape" && dlg.open) dlg.close();
            };

            window.addEventListener("keydown", onKeyDown, { passive: false });
            window.addEventListener("astro:before-swap", () => window.removeEventListener("keydown", onKeyDown));

            render(0);
          })();
        </script>
      </section>
    )}
  </article>
</BaseLayout>

<style>
  .page { width: 100%; margin: 0; }
  .head .subtitle { margin: 0.25rem 0 0.75rem; opacity: 0.85; }

  /* auf 800px fluchten */
  .intro, .intro p, .hint { max-width: 800px; }
  .intro { margin: 0 0 1rem; }
  .hint { opacity: 0.75; margin-top: -0.25rem; }

  .viewer-wrap {
    max-width: 800px;
    width: min(100%, 800px);
    margin: 0;
    padding: 0;
  }

  .frame { width: 100%; }

  .strip-scroll {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 6px;
    margin: 0 0 0.75rem;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-x: contain;
  }

  .strip {
    display: flex;
    flex-wrap: nowrap;
    gap: 10px;
    width: max-content;
  }

  .thumb {
    all: unset;
    cursor: pointer;
    display: block;
    width: 110px;
    height: 74px;
    flex: 0 0 auto;
    border-radius: 10px;
    overflow: hidden;
    border: 2px solid transparent;
    background: rgba(0,0,0,0.03);
  }

  .thumb img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
    max-width: none;
  }

  .thumb.is-active { border-color: rgba(0,0,0,0.35); }

  /* Hero ohne graue Fläche */
  .hero { margin: 0; }
  .hero-btn {
    all: unset;
    display: block;
    cursor: pointer;
    width: 100%;
    background: transparent;
  }

  .hero-frame { width: 100%; background: transparent; }

  .hero-frame.is-landscape img {
    display: block;
    width: 100%;
    height: auto;
    border-radius: 14px;
  }

  .hero-frame.is-portrait {
    height: 520px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
  }

  .hero-frame.is-portrait img {
    display: block;
    height: 100%;
    width: auto;
    border-radius: 14px;
  }

  .caption {
    margin-top: 0.6rem;
    font-size: 0.95rem;
    opacity: 0.85;
    line-height: 1.4;
    height: 5.6em;
    overflow-y: auto;
    padding-right: 0.25rem;
  }
</style>
